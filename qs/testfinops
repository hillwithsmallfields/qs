#!/bin/bash
TARBALL=~/qsfiles.tar
ORIGINALS=~/common/qs-playpen
SCRATCH=~/common/qs-scratch
CONFIGDIR=~/open-projects/github.com/hillwithsmallfields/qs/conf
CONVDIR=~/common/finances
QS=~/open-projects/github.com/hillwithsmallfields/qs/qs
if [ ! -f $TARBALL ]
then
    echo making $TARBALL from $ORIGINALS
    tar cf $TARBALL -C $ORIGINALS financisto-full.csv handelsbanken-full.csv financisto-1-year.csv handelsbanken-1-year.csv financisto-1-month.csv handelsbanken-1-month.csv
fi
mkdir -p $SCRATCH
rm -rf $SCRATCH/*
tar xf $TARBALL -C $SCRATCH
IMPORTDATE=$(date --iso-8601)
echo Running version from $QS
OUTBASE=/tmp/finout
rm -rf $OUTBASE/*

SCRIPT=${1-tests.fins}

SELECTIONS=${2-1-month 1-year full}

export SELECTION

for SELECTION in $SELECTIONS
do
    export OUTPUT=$OUTBASE/$SELECTION
    echo Running $SELECTION tests with output to $OUTPUT
    mkdir -p $OUTPUT
    rm -fr $OUTPUT/*
    ./finops.py --verbose --confirm-script $SCRIPT
    
    find $OUTBASE -name "*.csv" | xargs wc
done
